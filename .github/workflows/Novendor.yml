name: Build OnePlus 7 Kernel (No Vendor Blobs, AnyKernel + Boot Image)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - lineage-21
      - android-16

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup build environment
        run: |
          echo "üîß Installing dependencies..."
          apt-get update -y
          apt-get install -y bc bison flex clang lld llvm lz4 make python3 git zip curl wget ccache libssl-dev rsync tar xz-utils

      - name: Download prebuilt Clang toolchain
        run: |
          mkdir -p clang
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r530567.tar.gz -O clang.tar.gz
          tar -xf clang.tar.gz -C clang
          echo "‚úÖ Clang toolchain extracted."

      - name: Setup build variables
        run: |
          echo "üîß Setting up environment..."
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "PATH=$PWD/clang/bin:$PATH" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV
          mkdir -p out

      - name: Detect available defconfig
        run: |
          echo "üîç Checking available defconfigs..."
          ls arch/arm64/configs || true
          if [ ! -f arch/arm64/configs/guacamole_defconfig ]; then
            echo "‚ö†Ô∏è No guacamole_defconfig found ‚Äî trying default_defconfig"
            cp arch/arm64/configs/*defconfig arch/arm64/configs/guacamole_defconfig || true
          fi

      - name: Disable vendor dependencies
        run: |
          echo "üîß Disabling vendor-related configs..."
          sed -i '/CONFIG_VENDOR/d' arch/arm64/configs/guacamole_defconfig || true
          sed -i '/CONFIG_BUILD_ARM64_VENDOR/d' arch/arm64/configs/guacamole_defconfig || true
          sed -i '/CONFIG_ANDROID_VENDOR/d' arch/arm64/configs/guacamole_defconfig || true
          echo "# Vendor blobs disabled" >> arch/arm64/configs/guacamole_defconfig

      - name: Apply Netfilter/Conntrack Fix
        run: |
          echo "üîß Enabling Netfilter configs..."
          for cfg in CONFIG_NETFILTER CONFIG_NETFILTER_XTABLES CONFIG_NF_CONNTRACK \
            CONFIG_NF_CONNTRACK_IPV4 CONFIG_NF_CONNTRACK_IPV6 \
            CONFIG_IP_NF_IPTABLES CONFIG_IP6_NF_IPTABLES \
            CONFIG_IP_NF_FILTER CONFIG_IP6_NF_FILTER \
            CONFIG_IP6_NF_REJECT CONFIG_IP6_NF_TARGET_REJECT CONFIG_BRIDGE_NETFILTER; do
              grep -q "$cfg" arch/arm64/configs/guacamole_defconfig || echo "$cfg=y" >> arch/arm64/configs/guacamole_defconfig
          done

      - name: Build kernel
        run: |
          echo "‚öôÔ∏è Building kernel..."
          make O=out ARCH=arm64 guacamole_defconfig
          make O=out ARCH=arm64 -j$(nproc) CC=clang \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi-

      - name: Package AnyKernel
        run: |
          echo "üì¶ Packaging AnyKernel..."
          mkdir -p artifacts/AnyKernel
          git clone https://github.com/osm0sis/AnyKernel3 artifacts/AnyKernel || true
          cp out/arch/arm64/boot/Image.gz-dtb artifacts/AnyKernel/zImage || true
          cd artifacts/AnyKernel
          zip -r ../OnePlus7_AnyKernel.zip .
          cd ../..

      - name: Create boot image
        run: |
          echo "üíæ Creating boot image..."
          mkdir -p artifacts/boot
          wget -q https://mirrorbits.lineageos.org/full/guacamoleb/20251026/boot.img -O artifacts/boot/base.img
          if [ -f out/arch/arm64/boot/Image.gz-dtb ]; then
            mv out/arch/arm64/boot/Image.gz-dtb artifacts/boot/
            echo "Kernel Image copied successfully"
          fi
          cd artifacts/boot && zip -r ../boot-flashable.zip .

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus7_Kernel_NoVendor
          path: artifacts/
